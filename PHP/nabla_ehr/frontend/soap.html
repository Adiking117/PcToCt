<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SOAP Notes</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    textarea { width: 90%; margin-bottom: 10px; }
    label { font-weight: bold; }
  </style>
</head>
<body>
  <h1>ğŸ“ SOAP Notes</h1>
  <button onclick="goBack()">â¬…ï¸ Back</button>
  <button onclick="alert('Activate Nabla Chrome Extension and click COPY')">ğŸ”Š Invoke Nabla</button>

  <div>
    <label for="subjective">Subjective:</label><br />
    <textarea id="subjective" rows="3" placeholder="Waiting for Nabla note..."></textarea><br />

    <label for="objective">Objective:</label><br />
    <textarea id="objective" rows="3" placeholder="Waiting for Nabla note..."></textarea><br />

    <label for="assessment">Assessment:</label><br />
    <textarea id="assessment" rows="3" placeholder="Waiting for Nabla note..."></textarea><br />

    <label for="plan">Plan:</label><br />
    <textarea id="plan" rows="3" placeholder="Waiting for Nabla note..."></textarea><br />

    <button onclick="saveSOAP()">ğŸ’¾ Save Notes</button>
  </div>

  <script>
    const API_BASE = "../backend/";
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("patient_id");
    const encounterId = urlParams.get("encounter_id");

    const subjectiveField = document.getElementById("subjective");
    const objectiveField = document.getElementById("objective");
    const assessmentField = document.getElementById("assessment");
    const planField = document.getElementById("plan");

    function goBack() {
      window.location.href = `encounters.html?patient_id=${patientId}`;
    }

    function parseSOAP(text) {
      const regex = /Subjective\s*([\s\S]*?)\s*Objective\s*([\s\S]*?)\s*Assessment\s*([\s\S]*?)\s*Plan\s*([\s\S]*)/i;
      const match = text.match(regex);
      if (match) {
        return {
          subjective: match[1].trim(),
          objective: match[2].trim(),
          assessment: match[3].trim(),
          plan: match[4].trim()
        };
      }
      return null;
    }

    if (encounterId) {
      fetch(`${API_BASE}get_soap.php?encounter_id=${encounterId}`)
        .then(res => res.json())
        .then(data => {
          if (data) {
            subjectiveField.value = data.subjective || "";
            objectiveField.value = data.objective || "";
            assessmentField.value = data.assesment || "";
            planField.value = data.plan || "";
          }
        });
    }

    let populated = false;
    const intervalId = setInterval(async () => {
      if (populated) return;
      try {
        const text = await navigator.clipboard.readText();
        if (text.startsWith("Subjective")) {
          const soap = parseSOAP(text);
          if (soap) {
            subjectiveField.value = soap.subjective;
            objectiveField.value = soap.objective;
            assessmentField.value = soap.assessment;
            planField.value = soap.plan;
            populated = true;
            clearInterval(intervalId);
            try {
              await navigator.clipboard.writeText("");
            } catch (err) {
              console.warn("Clipboard not cleared:", err);
            }
          }
        }
      } catch (err) {
      }
    }, 2000);

    function saveSOAP() {
      fetch(`${API_BASE}save_soap.php`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          patient_id: patientId,
          encounter_id: encounterId,
          doctor_id: 1,
          subjective: subjectiveField.value,
          objective: objectiveField.value,
          assesment: assessmentField.value,
          plan: planField.value
        })
      })
      .then(res => res.json())
      .then(data => {
        alert("SOAP notes saved successfully!");
        goBack();
      });
    }
  </script>
</body>
</html>
